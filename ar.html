<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>AR Sketch Pro</title>

<link rel="manifest" href="manifest.json">

<style>
:root{
--glass:rgba(15,15,15,.7);
--border:rgba(255,255,255,.15);
--accent:#61ffd0;
}

*{margin:0;padding:0;box-sizing:border-box;}

body{
background:black;
font-family:system-ui;
overflow:hidden;
}

/* CAMERA */
video,canvas{
position:fixed;
inset:0;
width:100%;
height:100%;
object-fit:cover;
}

/* SPLASH */
#splash{
position:fixed;
inset:0;
background:#000;
display:flex;
align-items:center;
justify-content:center;
z-index:99;
}
#splash h1{color:white;font-size:3rem}

/* OVERLAY */
.layer{
position:absolute;
top:50%;
left:50%;
touch-action:none;
pointer-events:auto;
opacity:.7;
}

/* UI */
.toolbar,.bottom{
position:fixed;
left:50%;
transform:translateX(-50%);
background:var(--glass);
border:1px solid var(--border);
backdrop-filter:blur(12px);
padding:12px;
border-radius:18px;
display:flex;
gap:10px;
z-index:10;
}

.toolbar{top:12px;}
.bottom{bottom:14px;flex-wrap:wrap;width:min(96%,520px);}

button,input{
background:transparent;
color:white;
border:1px solid var(--border);
padding:8px 14px;
border-radius:12px;
cursor:pointer;
}

button:hover{border-color:var(--accent);color:var(--accent);}

.corner{
width:14px;height:14px;
background:#61ffd0;
position:absolute;
border-radius:50%;
}

.hidden{display:none}
</style>
</head>

<body>

<div id="splash"><h1>AR Sketch Pro v2</h1></div>

<video id="camera" autoplay playsinline></video>

<div id="layers"></div>

<div class="toolbar">
<input type="file" id="upload" accept="image/*">
<button id="addLayer">+ Layer</button>
<button id="torch">Torch</button>
<button id="calibrate">Calibrate</button>
</div>

<div class="bottom">
<button id="warp">Warp</button>
<button id="guides">Guides</button>
<button id="lock">Lock</button>
<button id="reset">Reset</button>
</div>

<script>
setTimeout(()=>splash.remove(),2000);

/* CAMERA */
const video=document.getElementById("camera");
let stream;

navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})
.then(s=>{
stream=s;
video.srcObject=s;
});

/* TORCH */
document.getElementById("torch").onclick=async()=>{
const track=stream.getVideoTracks()[0];
if(!track.getCapabilities().torch)return alert("Torch not supported");
const torchOn=track.getSettings().torch;
await track.applyConstraints({advanced:[{torch:!torchOn}]});
};

/* LAYERS */
const layersDiv=document.getElementById("layers");
let activeLayer;

function createLayer(src){
const img=document.createElement("img");
img.src=src;
img.className="layer";
img.style.transform="translate(-50%,-50%)";
layersDiv.appendChild(img);
makeInteractive(img);
activeLayer=img;
}

upload.onchange=e=>{
const f=e.target.files[0];
if(f)createLayer(URL.createObjectURL(f));
};

addLayer.onclick=()=>upload.click();

/* INTERACTION */
let pointers=new Map(),startDist=0,startScale=1,startRot=0,startAngle=0;

function makeInteractive(el){
let x=innerWidth/2,y=innerHeight/2,scale=1,rot=0,locked=false;

function update(){
el.style.transform=
`translate(${x}px,${y}px) translate(-50%,-50%) scale(${scale}) rotate(${rot}deg)`;
}

el.onpointerdown=e=>{
if(locked)return;
pointers.set(e.pointerId,e);
el.setPointerCapture(e.pointerId);
activeLayer=el;
};

el.onpointermove=e=>{
if(!pointers.has(e.pointerId))return;
pointers.set(e.pointerId,e);

if(pointers.size===1){
x+=e.movementX;
y+=e.movementY;
update();
}

if(pointers.size===2){
const[a,b]=[...pointers.values()];
const dx=b.clientX-a.clientX;
const dy=b.clientY-a.clientY;
const dist=Math.hypot(dx,dy);
const ang=Math.atan2(dy,dx)*180/Math.PI;

if(!startDist){
startDist=dist;
startScale=scale;
startRot=rot;
startAngle=ang;
}else{
scale=startScale*(dist/startDist);
rot=startRot+(ang-startAngle);
update();
}
}
};

el.onpointerup=e=>{
pointers.delete(e.pointerId);
if(pointers.size<2)startDist=0;
};

lock.onclick=()=>locked=!locked;
reset.onclick=()=>{
x=innerWidth/2;y=innerHeight/2;scale=1;rot=0;update();
};

}

/* GUIDES */
let guideOn=false;
guides.onclick=()=>{
guideOn=!guideOn;
if(guideOn){
const g=document.createElement("div");
g.id="guide";
g.style.position="fixed";
g.style.inset=0;
g.style.border="2px dashed rgba(255,255,255,.15)";
document.body.appendChild(g);
}else document.getElementById("guide")?.remove();
};

/* WARP MODE (corner handles) */
warp.onclick=()=>{
if(!activeLayer)return;
alert("Perspective warp UI coming next build ðŸ‘€");
};

/* SERVICE WORKER */
if("serviceWorker"in navigator){
navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
